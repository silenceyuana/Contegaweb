-- =================================================================
-- Supabase 初始化脚本 (v7.0 简化版)
-- 移除了 shop_items, purchase_history 表
-- 移除了 players 表中的 score 和 last_checkin_date 列
-- =================================================================

-- 先删除可能存在的旧表，以便重新创建
DROP TABLE IF EXISTS public.purchase_history;
DROP TABLE IF EXISTS public.shop_items;

-- 1. 创建玩家表 (players) - 简化版
DROP TABLE IF EXISTS public.players;
CREATE TABLE public.players (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  player_name text NOT NULL,
  email text NOT NULL,
  password_hash text NOT NULL,
  created_at timestamp with time zone DEFAULT now() NOT NULL
);
ALTER TABLE public.players ADD CONSTRAINT players_player_name_key UNIQUE (player_name);
ALTER TABLE public.players ADD CONSTRAINT players_email_key UNIQUE (email);
ALTER TABLE public.players ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable read access for all users" ON public.players FOR SELECT USING (true);
CREATE POLICY "Enable insert for authenticated users only" ON public.players FOR INSERT WITH CHECK (true);

-- 2. 创建管理员表 (users) - 无变化
DROP TABLE IF EXISTS public.users;
CREATE TABLE public.users (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  username text NOT NULL,
  password_hash text NOT NULL,
  created_at timestamp with time zone DEFAULT now() NOT NULL
);
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable read access for all users" ON public.users FOR SELECT USING (true);


-- 3. 创建工单消息表 (contact_messages) - 无变化
DROP TABLE IF EXISTS public.contact_messages;
CREATE TABLE public.contact_messages (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  player_name text,
  email text,
  message text,
  created_at timestamp with time zone DEFAULT now()
);
ALTER TABLE public.contact_messages ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable insert for authenticated users only" ON public.contact_messages FOR INSERT WITH CHECK (true);
CREATE POLICY "Enable delete for users based on user_id" ON public.contact_messages FOR DELETE USING (true);
CREATE POLICY "Enable read access for all users" ON public.contact_messages FOR SELECT USING (true);

-- 4. 创建封禁玩家表 (banned_players) - 无变化
DROP TABLE IF EXISTS public.banned_players;
CREATE TABLE public.banned_players (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  player_name text NOT NULL,
  reason text NOT NULL,
  duration text NOT NULL,
  ban_date date NOT NULL,
  created_at timestamp with time zone DEFAULT now() NOT NULL
);
ALTER TABLE public.banned_players ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable insert for authenticated users only" ON public.banned_players FOR INSERT WITH CHECK (true);
CREATE POLICY "Enable delete for users based on user_id" ON public.banned_players FOR DELETE USING (true);
CREATE POLICY "Enable read access for all users" ON public.banned_players FOR SELECT USING (true);


-- 5. 创建赞助者表 (sponsors) - 无变化
DROP TABLE IF EXISTS public.sponsors;
CREATE TABLE public.sponsors (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name text NOT NULL,
  amount text NOT NULL,
  created_at timestamp with time zone DEFAULT now() NOT NULL
);
ALTER TABLE public.sponsors ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable insert for authenticated users only" ON public.sponsors FOR INSERT WITH CHECK (true);
CREATE POLICY "Enable delete for users based on user_id" ON public.sponsors FOR DELETE USING (true);
CREATE POLICY "Enable read access for all users" ON public.sponsors FOR SELECT USING (true);

-- 6. (可选) 创建服务器规则表 (server_rules) - 无变化
DROP TABLE IF EXISTS public.server_rules;
CREATE TABLE public.server_rules (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    category text,
    description text
);
ALTER TABLE public.server_rules ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable read access for all users" ON public.server_rules FOR SELECT USING (true);
CREATE POLICY "Enable insert for authenticated users only" ON public.server_rules FOR INSERT WITH CHECK (true);
CREATE POLICY "Enable delete for users based on user_id" ON public.server_rules FOR DELETE USING (true);



-- **重要**: 插入你的第一个管理员账户
-- 你需要手动生成密码的 bcrypt 哈希值并替换下面的 'YOUR_BCRYPT_HASH_HERE'
-- 你可以使用在线工具或本地脚本生成。
-- 例如: 'admin' / 'password123'
INSERT INTO public.users (username, password_hash) VALUES
('yuan', '$2a$12$AqudxU7A7V3zKrzJXgg0Wur/REfcFrqZ.X5mRJxQHLONckeQSwvOq');







 数据库配置文件






环境变量：

SUPABASE_URL	
必需。您的 Supabase 项目的唯一 API 地址。您的 Express 服务器将使用此 URL 与数据库进行通信。	1. 登录 Supabase。<br>2. 进入您的项目。<br>3. 点击左侧的 Settings (齿轮图标)。<br>4. 选择 API。5. 在 "Project URL" 部分，复制该 URL。


SUPABASE_ANON_KEY	
必需。您的 Supabase 项目的公共 "匿名" 密钥。此密钥用于在客户端（或您的服务器）安全地访问数据库，它遵循您设置的行级安全策略（RLS）。	1. 在与上面相同的 API 设置页面。<br>2. 在 "Project API Keys" 部分。<br>3. 复制 anon public 密钥。注意：不要使用 service_role 密钥，这非常重要，因为 service_role 密钥会绕过所有安全策略。

JWT_SECRET	
必需。一个用于签名和验证 JSON Web Tokens (JWT) 的密钥。它保证了用户登录状态（Token）的安全性和真实性，防止被伪造。	您需要自己创建一个这个值。它必须是一个长久、随机且保密的字符串。不要使用简单或可预测的密码。<br><br>生成方法推荐：<br>• 使用密码管理器：生成一个 32 或 64 个字符的随机密码。<br>• 使用在线生成器：例如 random.org 或 1Password Generator。<br>• 示例 (请勿直接使用): a_very_long_and_super_secret_string_for_my_jwt_!@#$1234













-- 7. (新增) 创建待验证用户表 (pending_verifications)
-- 此表用于存储注册过程中用户的临时信息和邮箱验证码
DROP TABLE IF EXISTS public.pending_verifications;
CREATE TABLE public.pending_verifications (
  email text NOT NULL PRIMARY KEY,
  player_name text NOT NULL,
  password_hash text NOT NULL,
  verification_code text NOT NULL,
  created_at timestamp with time zone DEFAULT now() NOT NULL,

  expires_at timestamp with time zone DEFAULT (now() + interval '20 minute') NOT NULL
);
COMMENT ON TABLE public.pending_verifications IS '存储待邮件验证的用户注册信息。';
ALTER TABLE public.pending_verifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow service role access" ON public.pending_verifications FOR ALL USING (true);




CREATE TABLE public.special_permissions (

  player_id bigint NOT NULL PRIMARY KEY,
  
 

  CONSTRAINT special_permissions_player_id_fkey FOREIGN KEY (player_id) 
  REFERENCES public.players (id) ON DELETE CASCADE
);


ALTER TABLE public.special_permissions ENABLE ROW LEVEL SECURITY;


CREATE POLICY "Enable all access for service-role" 
ON public.special_permissions FOR ALL 
USING (auth.role() = 'service_role');





-- 创建一个新表，用于存储密码重置令牌
CREATE TABLE public.password_resets (
  -- 用户的邮箱，作为主键，确保一个邮箱同时只能有一个重置请求
  email text NOT NULL PRIMARY KEY,
  
  -- 用于验证的唯一令牌
  token text NOT NULL,
  
  -- 令牌的过期时间，设置为1小时后
  expires_at timestamp with time zone NOT NULL DEFAULT (now() + interval '1 hour')
);

-- 为这张表启用行级安全策略（RLS）
ALTER TABLE public.password_resets ENABLE ROW LEVEL SECURITY;

-- 创建一个策略，允许后端服务器进行所有操作
CREATE POLICY "Enable all access for service-role" 
ON public.password_resets FOR ALL 
USING (auth.role() = 'service_role');










SUPABASE_SERVICE_KEY  密钥权限