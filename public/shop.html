<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>积分商城 - 筑界物语服务器</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="images/1.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .shop-page { padding: 100px 20px 40px; }
        .shop-header { text-align: center; margin-bottom: 2rem; }
        .shop-header h1 { color: #ffd700; }
        .player-score-bar {
            background: rgba(0,0,0,0.3);
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 2rem;
            text-align: center;
            font-size: 1.2rem;
        }
        #current-score { color: #ffd700; font-weight: bold; }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; }
        
     
        .shop-item {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }
        .item-name { 
            font-size: 1.3rem; 
            color: #fff; 
            margin-bottom: 1.5rem; 
        }
        .item-price { 
            font-size: 1.5rem; 
            color: #ffd700; 
            margin-bottom: 1.5rem; 
        }
        .purchase-btn { background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; width: 100%; }
    

        .purchase-history { margin-top: 3rem; }
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th, .history-table td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .history-table th { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-logo"><a href="index.html"><i class="fas fa-cube"></i><span> 筑界物语服务器</span></a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="index.html" class="nav-link">返回首页</a></li>
                    <li id="auth-container" class="nav-item">
                        <a href="login.html" class="nav-link"><b>登录</b></a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <main class="shop-page">
        <div class="container">
            <div class="shop-header">
                <h1><i class="fas fa-store"></i> 积分商城</h1>
                <p>使用您通过签到获得的积分来兑换奖励！</p>
            </div>
            
            <div id="shop-login-prompt" style="display: none; text-align: center; background: rgba(231, 76, 60, 0.2); padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem;">
                <p>请先 <a href="login.html">登录</a> 才能查看积分和购买商品。</p>
            </div>

            <div id="shop-content" style="display: none;">
                <div class="player-score-bar">
                    <i class="fas fa-coins"></i> 您当前的积分: <span id="current-score">加载中...</span>
                </div>
                <div id="shopGrid" class="shop-grid">
            
                </div>

                <div class="purchase-history">
                    <h2 style="text-align:center; margin-bottom: 1.5rem;">我的购买记录</h2>
                    <table class="history-table">
                        <thead><tr><th>商品名称</th><th>花费积分</th><th>购买日期</th><th>状态</th></tr></thead>
                        <tbody id="purchaseHistoryContainer"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        const playerToken = localStorage.getItem('playerAuthToken');
        const isLoggedIn = !!playerToken;

        document.addEventListener('DOMContentLoaded', () => {
            if (isLoggedIn) {
                document.getElementById('shop-content').style.display = 'block';
                fetchShopItems();
                fetchPlayerStatus();
                fetchPurchaseHistory();
            } else {
                document.getElementById('shop-login-prompt').style.display = 'block';
            }
        });

        async function fetchShopItems() {
            const grid = document.getElementById('shopGrid');
            try {
                const response = await fetch('/api/shop/items');
                const items = await response.json();
                
             
                grid.innerHTML = items.map(item => `
                    <div class="shop-item">
                        <h3 class="item-name">${item.name}</h3>
                        <div class="item-price"><i class="fas fa-coins"></i> ${item.price}</div>
                        <button class="purchase-btn" onclick="purchaseItem(${item.id})">购买</button>
                    </div>
                `).join('');
            

            } catch (error) {
                grid.innerHTML = '<p>加载商品失败，请刷新页面。</p>';
            }
        }
        
       
        async function fetchPlayerStatus() { const scoreSpan = document.getElementById('current-score'); try { const response = await fetch('/api/player/status', { headers: { 'Authorization': `Bearer ${playerToken}` } }); const data = await response.json(); scoreSpan.textContent = data.score; } catch (error) { scoreSpan.textContent = '获取失败'; } }
        async function fetchPurchaseHistory() { const historyContainer = document.getElementById('purchaseHistoryContainer'); try { const response = await fetch('/api/player/purchases', { headers: { 'Authorization': `Bearer ${playerToken}` } }); const history = await response.json(); if(history.length === 0){ historyContainer.innerHTML = '<tr><td colspan="4" style="text-align:center;">暂无购买记录</td></tr>'; return; } historyContainer.innerHTML = history.map(p => `<tr><td>${p.item_name}</td><td>${p.price_paid}</td><td>${new Date(p.purchase_date).toLocaleString()}</td><td>${p.status}</td></tr>`).join(''); } catch (error) { historyContainer.innerHTML = '<tr><td colspan="4" style="color:red;">加载历史记录失败</td></tr>'; } }
        async function purchaseItem(itemId) { if (!confirm('确定要购买此商品吗？积分将被扣除。')) return; try { const response = await fetch('/api/shop/purchase', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${playerToken}` }, body: JSON.stringify({ itemId }) }); const result = await response.json(); if (!response.ok) throw new Error(result.error); alert('购买成功！'); document.getElementById('current-score').textContent = result.newScore; fetchPurchaseHistory(); } catch (error) { alert(`购买失败: ${error.message}`); } }
    </script>
</body>
</html>